<title>New runs at speedrun.com</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  .run{
    margin:.2em;
    display:inline-block;
    border-radius:.25em;
    padding:.5em;
  }
  
  .rank1{background-color:gold;}
  .rank2{background-color:silver;}
  body.toponly .run.ranked{display:none;}
  body.toponly .run.ranked.rank1,body.toponly .run.ranked.rank2{display:inline-block;}
</style>
<div><label><input type='checkbox' id='filter' checked>Show only top runs</label></div>
<script type='module'>
  const API='https://www.speedrun.com/api/v1/'
  const RATE=Math.ceil(60*1000/100)
  const FILTER=document.querySelector('#filter')
  const FILTERED='toponly'
  
  var next=API+'runs?status=verified&orderby=verify-date&direction=desc&embed=game,category'

  function add(run){
    let level=run['level']
    if(level) return;
    let a=document.createElement('a')
    a.classList.add('run')
    a.run=run
    a.href=run['weblink']
    a.target='_blank'
    let name=run['game']['data']['names']['international']
    let category=run['category']['data']['name']
    let time=run['times']['primary_t']
    let hours=Math.round(Math.floor(time/60/60))
    let minutes=Math.round(Math.floor(time/60))%60
    if(minutes<10) minutes='0'+minutes
    time=`${hours}:${minutes}`
    a.innerHTML=`${name} (${category}) in ${time}`
    document.body.appendChild(a)
  }
  
  async function scan(){
    if(!next) return
    let url=next
    next=false
    let runs=await fetch(url)
    runs=await runs.json()
    for(let r of runs['data']) add(r)
    let page=runs['pagination']['links'][1]||runs['pagination']['links'][0]
    next=page['uri']
  }
  
  async function rank(a){
    a.classList.add('ranked')
    let game=a.run['game']['data']['id']
    let category=a.run['category']['data']['id']
    let leaderboard=await fetch(API+`leaderboards/${game}/category/${category}`)
    leaderboard=await leaderboard.json()
    let l=leaderboard['data']['runs'].find(l=>l['run']['id']==a.run['id'])
    if(!l) return
    let rank=Number(l['place'])
    a.innerHTML=`#${rank}. ${a.innerHTML}`
    a.classList.add('rank'+rank)
  }
  
  async function tick(){
    let a=Array.from(document.querySelectorAll('a')).find(a=>!a.classList.contains('ranked'))
    if(a) rank(a)
    else scan()
  }
  
  function filter(){
    if(FILTER.checked){
      document.body.classList.remove(FILTERED)
    }else{
      document.body.classList.add(FILTERED)
    }
  }
  
  document.body.classList.add(FILTERED)
  setInterval(tick,RATE)
  FILTER.onclick=filter
</script>
